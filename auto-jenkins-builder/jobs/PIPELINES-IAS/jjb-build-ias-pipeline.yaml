### JOBS ###
- job:
    name: jjb-deploy-ias-pipeline
    project-type: pipeline
    sandbox: true
    logrotate:
      numToKeep: 10
    parameters:
      - cascade-choice:
          project: 'jjb-deploy-ias-pipeline'
          name: IAS_VERSION
          script: |
              import groovy.json.JsonSlurperClassic

              def addr       = "https://harbor.whirl.sg/api/repositories/ias/app/tags"
              def authString = 'jenkins:AQ!SW@de3?'.getBytes().encodeBase64().toString()

              def conn = addr.toURL().openConnection()
              conn.setRequestProperty( "Authorization", "Basic ${authString}" )
              if( conn.responseCode == 200 ) {
                def data = new JsonSlurperClassic().parseText( conn.content.text )
                return data.name

              }
          visible-item-count: 1
          fallback-script: |
            return ['Something Wrong']
          reference: ''
          choice-type: single
          filterable: True
      - string:
          name: DEVOPS_BR
          default: '${DEFAULT_DEVOPS_BRANCH}'
      - string:
          name: DA_CPP_LIBS_BR
          default: '${DA_CPP_LIBS_BR}'
      - string:
          name: DA_CV_BR
          default: '${DA_CV_BR}'
      - choice:
          name: JOB_TYPE
          choices:
            - generic
            - generic_with_env
            - buildenv
            - scratch
          description: "generic: Build only app image (harbor.whirl.sg/ias/app)
                        generic_with_env: Build environment images and app image (harbor.whirl.sg/ias/app-deps, harbor.whirl.sg/ias/buildenv and harbor.whirl.sg/ias/app)
                        buildenv: Build only environment images (harbor.whirl.sg/ias/app-deps and harbor.whirl.sg/ias/buildenv)
                        scratch: Build app image based on dockerhub images (nvidia/cuda:8.0-cudnn5-devel as buildenv and nvidia/cuda:8.0-cudnn5-runtime as app image)"
    pipeline-scm:
      scm:
        - git:
            url: http://git-cache.dev.whirl.sg:9909/bitbucket.org/whirlsoftware/whirl_devops
            credentials-id: '87657576578657685'
            branches:
              -  '*/${DEVOPS_BR}'
      script-path: 'pipelines/ias/Jenkinsfile'

### VIEWS ###
- view:
    name: jenkins-builders
    view-type: list
    description: 'Jenkins View for IAS'
    filter-executors: false
    filter-queue: false
    job-name:
        - jjb-deploy-ias-pipeline
    columns:
        - status
        - weather
        - job
        - last-success
        - last-failure
        - last-duration
        - last-duration
        - build-button

